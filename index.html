<!DOCTYPE html>
<html lang="en">
<head>
    <style>
        
        .history-log {
            margin: 20px;
            padding: 10px;
            border: 1px solid #ccc;
            max-height: 300px;
            overflow-y: auto;
        }
        .sub-buttons {
            margin: 10px 0;
        }
        .timestamp {
            color: #666;
            font-size: 0.8em;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Rugby Stats Tracker</h1>
        
        <div class="team-section">
            <!-- Home Team -->
            <div class="team">
                // ... existing score buttons ...

                <h3>Bench</h3>
                <div id="player-pool" class="player-list">
                    <div class="player" draggable="true" data-player-id="1">
                        <span class="player-name">Player 1</span>
                        <span class="player-number">#1</span>
                        <span class="player-position">Prop</span>
                    </div>
                    <!-- Add more players as needed -->
                </div>
                
                <h3>On Field</h3>
                <div id="active-players" class="player-list"></div>

                <div class="sub-buttons">
                    <button onclick="recordSubstitution()">Record Substitution</button>
                </div>
            </div>

            <!-- Away Team section remains the same -->
        </div>

        <div class="match-controls">
            <button onclick="startMatch()">Start Match</button>
            <button onclick="saveMatch()">Save Match</button>
            <button onclick="loadMatch()">Load Last Match</button>
        </div>

        <h3>Match History</h3>
        <div id="history-log" class="history-log"></div>
    </div>

    <script>
        // ... existing score tracking code ...

        let matchHistory = [];
        let matchStartTime = null;
        let matchData = {
            scores: { home: 0, away: 0 },
            substitutions: [],
            events: []
        };

        function startMatch() {
            matchStartTime = new Date();
            matchHistory = [];
            matchData = {
                scores: { home: 0, away: 0 },
                substitutions: [],
                events: []
            };
            logEvent('Match Started');
        }

        function getMatchTime() {
            if (!matchStartTime) return '00:00';
            const diff = new Date() - matchStartTime;
            const minutes = Math.floor(diff / 60000);
            const seconds = Math.floor((diff % 60000) / 1000);
            return `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
        }

        function updateScore(team, points) {
            scores[team] += points;
            matchData.scores[team] = scores[team];
            document.getElementById(`${team}-score`).textContent = scores[team];
            
            const scoreType = points === 5 ? 'Try' : 
                            points === 2 ? 'Conversion' :
                            points === 3 ? 'Penalty/Drop Goal' : 'Score';
            
            logEvent(`${team.toUpperCase()} TEAM - ${scoreType} (+${points})`);
        }

        function recordSubstitution() {
            const playerOut = document.querySelector('#active-players .player.selected');
            const playerIn = document.querySelector('#player-pool .player.selected');

            if (!playerOut || !playerIn) {
                alert('Please select both players for substitution');
                return;
            }

            const sub = {
                timeStamp: getMatchTime(),
                playerOutId: playerOut.dataset.playerId,
                playerOutName: playerOut.querySelector('.player-name').textContent,
                playerInId: playerIn.dataset.playerId,
                playerInName: playerIn.querySelector('.player-name').textContent
            };

            matchData.substitutions.push(sub);
            logEvent(`Substitution: ${sub.playerOutName} OFF, ${sub.playerInName} ON`);

            // Swap players between containers
            const activePlayers = document.getElementById('active-players');
            const playerPool = document.getElementById('player-pool');
            activePlayers.appendChild(playerIn);
            playerPool.appendChild(playerOut);

            // Clear selections
            document.querySelectorAll('.player.selected').forEach(p => p.classList.remove('selected'));
        }

        function logEvent(event) {
            const timeStamp = getMatchTime();
            const eventData = { timeStamp, event };
            matchData.events.push(eventData);

            const historyLog = document.getElementById('history-log');
            const eventElement = document.createElement('div');
            eventElement.innerHTML = `<span class="timestamp">[${timeStamp}]</span> ${event}`;
            historyLog.appendChild(eventElement);
            historyLog.scrollTop = historyLog.scrollHeight;
        }

        function saveMatch() {
            const matchSummary = {
                date: new Date().toISOString(),
                matchData: matchData
            };
            localStorage.setItem('lastMatch', JSON.stringify(matchSummary));
            alert('Match saved successfully!');
        }

        function loadMatch() {
            const savedMatch = localStorage.getItem('lastMatch');
            if (savedMatch) {
                const matchSummary = JSON.parse(savedMatch);
                // Restore match data
                matchData = matchSummary.matchData;
                
                // Clear and rebuild history log
                const historyLog = document.getElementById('history-log');
                historyLog.innerHTML = '';
                matchData.events.forEach(event => {
                    const eventElement = document.createElement('div');
                    eventElement.innerHTML = `<span class="timestamp">[${event.timeStamp}]</span> ${event.event}`;
                    historyLog.appendChild(eventElement);
                });

                // Restore scores
                scores.home = matchData.scores.home;
                scores.away = matchData.scores.away;
                document.getElementById('home-score').textContent = scores.home;
                document.getElementById('away-score').textContent = scores.away;

                alert('Match loaded successfully!');
            } else {
                alert('No saved match found!');
            }
        }

        // Enhanced drag and drop functionality
        document.addEventListener('DOMContentLoaded', () => {
            // ... existing drag and drop setup ...

            // Add click selection for substitutions
            document.querySelectorAll('.player').forEach(player => {
                player.addEventListener('click', () => {
                    const container = player.parentElement;
                    // Only allow one selection per container
                    container.querySelectorAll('.selected').forEach(p => {
                        if (p !== player) p.classList.remove('selected');
                    });
                    player.classList.toggle('selected');
                });
            });
        });

        // ... existing drag and drop functions ...
    </script>
</body>
</html>
